<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ダイスロール</title>
  <style>
    body {
      margin: 16px;
      font-family: sans-serif;
      text-align: center;
    }
    button {
      padding: 12px 16px;
      margin: 4px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      background-color: #007bff;
      color: #fff;
    }
    /* ダイスロールボタンのみ2emに */
    #roll {
      font-size: 2em;
    }
    button:active {
      opacity: 0.8;
    }
    #dice-container {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      margin: 16px 0;
    }
    #dice-container img {
      width: 60px;
      height: 60px;
      margin: 0 4px;
    }
    .separator {
      border-left: 2px solid #000;
      height: 60px;
      margin: 0 12px;
    }
    #result {
      font-size: 2em;
      margin: 8px 0 4px;
    }
    #judgment {
      font-size: 1.2em;
      margin-bottom: 8px;
      color: #c00;
    }
    #hard-success,
    #extreme-success {
      font-size: 18px;
      margin: 8px 0;
    }
    .bright {
      filter: brightness(1.2);
    }
    .dark {
      filter: brightness(0.5);
    }
  </style>
</head>
<body>
  <button id="roll">ダイスロール</button>
  <button id="bonus">ボーナスダイス</button>
  <button id="penalty">ペナルティダイス</button>

  <div id="dice-container"></div>
  <div id="result"></div>
  <div id="judgment"></div>
  <div id="hard-success"></div>
  <div id="extreme-success"></div>

  <script>
    const diceContainer = document.getElementById('dice-container');
    const resultDiv     = document.getElementById('result');
    const judgmentDiv   = document.getElementById('judgment');
    const hardDiv       = document.getElementById('hard-success');
    const extremeDiv    = document.getElementById('extreme-success');
    const successRate   = 50;

    function animateDice(img, callback) {
      const spins = Math.floor(Math.random() * 6) + 10;
      let count = 0, face = 0;
      const iv = setInterval(() => {
        img.src = '10_' + face + '.png';
        face = Math.floor(Math.random() * 10);
        if (++count >= spins) {
          clearInterval(iv);
          const finalFace = Math.floor(Math.random() * 10);
          img.src = '10_' + finalFace + '.png';
          callback(finalFace);
        }
      }, 50);
    }

    function displayResults(tens, ones) {
      let num = tens * 10 + ones;
      if (num === 0) num = 100;
      else if (tens === 0) num = ones;

      resultDiv.textContent = num;
      judgmentDiv.textContent = '';

      if (num === 100) {
        judgmentDiv.textContent = 'ファンブル';
      } else if (num === 1) {
        judgmentDiv.textContent = 'クリティカル';
      } else if (num > 95) {
        judgmentDiv.textContent = '成功率が50未満ならファンブル';
      }

      const hardVal = num * 2;
      hardDiv.textContent = (hardVal < 99 ? 'ハード成功 ' + hardVal : '');
      const extremeVal = num * 5;
      extremeDiv.textContent = (extremeVal < 99 ? 'エクストリーム成功 ' + extremeVal : '');
    }

    function basicRoll() {
      diceContainer.innerHTML = '';
      resultDiv.textContent   = '';
      judgmentDiv.textContent = '';
      hardDiv.textContent     = '';
      extremeDiv.textContent  = '';

      const imgs = [], vals = [];
      for (let i = 0; i < 2; i++) {
        const img = document.createElement('img');
        img.src = '10_0.png';
        diceContainer.appendChild(img);
        imgs.push(img);
      }
      let done = 0;
      imgs.forEach((img, i) => {
        animateDice(img, v => {
          vals[i] = v;
          if (++done === 2) displayResults(vals[0], vals[1]);
        });
      });
    }

    function bonusPenaltyRoll(isBonus) {
      diceContainer.innerHTML = '';
      resultDiv.textContent   = '';
      judgmentDiv.textContent = '';
      hardDiv.textContent     = '';
      extremeDiv.textContent  = '';

      const imgT1 = document.createElement('img');
      const imgT2 = document.createElement('img');
      const sep   = document.createElement('div'); sep.className = 'separator';
      const imgO  = document.createElement('img');

      imgT1.src = imgT2.src = imgO.src = '10_0.png';
      diceContainer.append(imgT1, imgT2, sep, imgO);

      const values = {}, total = { cnt: 0 };
      const doneCheck = () => {
        if (total.cnt === 3) {
          let brighterIndex;
          if (isBonus) {
            brighterIndex = (values.t1 <= values.t2) ? 1 : 2;
          } else {
            const eff1 = (values.t1 === 0 ? 10 : values.t1);
            const eff2 = (values.t2 === 0 ? 10 : values.t2);
            brighterIndex = (eff1 >= eff2) ? 1 : 2;
          }
          if (brighterIndex === 1) {
            imgT1.classList.add('bright');
            imgT2.classList.add('dark');
          } else {
            imgT2.classList.add('bright');
            imgT1.classList.add('dark');
          }

          if (!isBonus && values.o === 0 && (values.t1 === 0 || values.t2 === 0)) {
            displayResults(0, 0);
          } else if (isBonus && values.o === 0 && (values.t1 === 0 || values.t2 === 0)) {
            const tensVal = (values.t1 === 0 ? values.t2 : values.t1);
            displayResults(tensVal, 0);
          } else {
            const tens = (brighterIndex === 1 ? values.t1 : values.t2);
            displayResults(tens, values.o);
          }
        }
      };

      animateDice(imgT1, v => { values.t1 = v; total.cnt++; doneCheck(); });
      animateDice(imgT2, v => { values.t2 = v; total.cnt++; doneCheck(); });
      animateDice(imgO,  v => { values.o  = v; total.cnt++; doneCheck(); });
    }

    document.getElementById('roll')   .addEventListener('click', basicRoll);
    document.getElementById('bonus')  .addEventListener('click', () => bonusPenaltyRoll(true));
    document.getElementById('penalty').addEventListener('click', () => bonusPenaltyRoll(false));
  </script>
</body>
</html>
