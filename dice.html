<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ダイスロール</title>
  <style>
    body {
      margin: 16px;
      font-family: sans-serif;
      text-align: center;
    }
    button {
      padding: 12px 16px;
      margin: 4px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      background-color: #007bff;
      color: #fff;
    }
    /* ダイスロールボタンのみ2emに */
    #roll {
      font-size: 2em;
    }
    button:active {
      opacity: 0.8;
    }
    #dice-container {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      margin: 16px 0;
    }
    #dice-container img {
      width: 90px;
      height: 90px;
      margin: 0 4px;
    }
    .separator {
      border-left: 2px solid #000;
      height: 90px;
      margin: 0 12px;
    }
    #result {
      font-size: 2em;
      margin: 8px 0 4px;
    }
    #judgment {
      font-size: 1.2em;
      margin-bottom: 8px;
      color: #c00;
    }
    #hard-success,
    #extreme-success {
      font-size: 18px;
      margin: 8px 0;
    }
    .bright {
      filter: brightness(1.2);
    }
    .dark {
      filter: brightness(0.5);
    }
  </style>
</head>
<body>
  <button id="roll">ダイスロール</button><br>
  <button id="bonus">ボーナスダイス</button>
  <button id="penalty">ペナルティダイス</button>

  <div id="dice-container"></div>
  <div id="result"></div>
  <div id="judgment"></div>
  <div id="hard-success"></div>
  <div id="extreme-success"></div>

  <script>
    const diceContainer = document.getElementById('dice-container');
    const resultDiv     = document.getElementById('result');
    const judgmentDiv   = document.getElementById('judgment');
    const hardDiv       = document.getElementById('hard-success');
    const extremeDiv    = document.getElementById('extreme-success');

    function animateDice(img, callback) {
      const spins = Math.floor(Math.random() * 6) + 10;
      let count = 0, face = 0;
      const iv = setInterval(() => {
        img.src = '10_' + face + '.png';
        face = Math.floor(Math.random() * 10);
        if (++count >= spins) {
          clearInterval(iv);
          const finalFace = Math.floor(Math.random() * 10);
          img.src = '10_' + finalFace + '.png';
          callback(finalFace);
        }
      }, 50);
    }

    // 候補結果を計算するヘルパー
    function candidateValue(tens, ones) {
      let v = tens * 10 + ones;
      if (v === 0)      return 100;  // 00 → 100
      if (tens === 0)   return ones; // 0x → x
      return v;                     // 通常
    }

    function displayResults(tens, ones) {
      let num = candidateValue(tens, ones);
      resultDiv.textContent = num;
      judgmentDiv.textContent = '';

      if (num === 100) {
        judgmentDiv.textContent = 'ファンブル';
      } else if (num === 1) {
        judgmentDiv.textContent = 'クリティカル';
      } else if (num > 95) {
        judgmentDiv.textContent = '成功率が50未満ならファンブル';
      }

      const hardVal = num * 2;
      hardDiv.textContent    = (hardVal < 99 ? hardVal + '以上ならハード成功 ' : '');
      const extremeVal = num * 5;
      extremeDiv.textContent = (extremeVal < 99 ? extremeVal + '以上ならエクストリーム成功 ' : '');
    }

    function basicRoll() {
      diceContainer.innerHTML = '';
      resultDiv.textContent   = '';
      judgmentDiv.textContent = '';
      hardDiv.textContent     = '';
      extremeDiv.textContent  = '';

      const imgs = [], vals = [];
      for (let i = 0; i < 2; i++) {
        const img = document.createElement('img');
        img.src = '10_0.png';
        diceContainer.appendChild(img);
        imgs.push(img);
      }
      let done = 0;
      imgs.forEach((img, i) => {
        animateDice(img, v => {
          vals[i] = v;
          if (++done === 2) displayResults(vals[0], vals[1]);
        });
      });
    }

    function bonusPenaltyRoll(isBonus) {
      diceContainer.innerHTML = '';
      resultDiv.textContent   = '';
      judgmentDiv.textContent = '';
      hardDiv.textContent     = '';
      extremeDiv.textContent  = '';

      const imgT1 = document.createElement('img');
      const imgT2 = document.createElement('img');
      const sep   = document.createElement('div'); sep.className = 'separator';
      const imgO  = document.createElement('img');
      imgT1.src = imgT2.src = imgO.src = '10_0.png';
      diceContainer.append(imgT1, imgT2, sep, imgO);

      const values = {}, total = { cnt: 0 };
      const doneCheck = () => {
        if (total.cnt !== 3) return;

        // 候補値を計算
        const c1 = candidateValue(values.t1, values.o);
        const c2 = candidateValue(values.t2, values.o);

        // 小さい／大きいほうを選ぶ
        let chosenIndex;
        if (isBonus) {
          chosenIndex = c1 <= c2 ? 1 : 2;
        } else {
          chosenIndex = c1 >= c2 ? 1 : 2;
        }

        // 明るさ設定
        if (chosenIndex === 1) {
          imgT1.classList.add('bright');
          imgT2.classList.add('dark');
        } else {
          imgT2.classList.add('bright');
          imgT1.classList.add('dark');
        }

        // その結果で描画
        const tens  = chosenIndex === 1 ? values.t1 : values.t2;
        displayResults(tens, values.o);
      };

      animateDice(imgT1, v => { values.t1 = v; total.cnt++; doneCheck(); });
      animateDice(imgT2, v => { values.t2 = v; total.cnt++; doneCheck(); });
      animateDice(imgO,  v => { values.o  = v; total.cnt++; doneCheck(); });
    }

    document.getElementById('roll')   .addEventListener('click', basicRoll);
    document.getElementById('bonus')  .addEventListener('click', () => bonusPenaltyRoll(true));
    document.getElementById('penalty').addEventListener('click', () => bonusPenaltyRoll(false));
  </script>
</body>
</html>
