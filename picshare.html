<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>問診票画像ジェネレーター（3:4縦長 / 即時再生成）</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="color-scheme" content="light dark" />
<style>
  /* ===== ベース（モバイル最適 & ダーク/ライト） ===== */
  :root{
    --bg:#0e1116; --fg:#e7eaee; --muted:#97a1ad;
    --accent:#2f81f7; --accent-press:#1f6fe0;
    --border:#2b3138; --radius:12px; --space:clamp(14px,3.6vw,22px);
    --maxw:780px;
  }
  @media (prefers-color-scheme: light){
    :root{ --bg:#f6f7f9; --fg:#0f1720; --muted:#5b6776; --border:#e5e7eb; }
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0; color:var(--fg); background:var(--bg);
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
    -webkit-font-smoothing:antialiased; line-height:1.6;
    padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
  }
  .wrap{max-width:var(--maxw); margin:0 auto; padding:var(--space)}

  /* ===== ヘッダ（カコミ無し） ===== */
  header h1{ margin:0 0 6px; font-size:clamp(20px,5.4vw,28px); letter-spacing:.02em }
  header p{ margin:0 0 var(--space); color:var(--muted); font-size:.95rem }

  /* ===== 入力フォーム ===== */
  .section-title{
    margin:22px 0 10px;
    font-weight:800;
    font-size: clamp(16px,4.4vw,20px);
    letter-spacing:.02em;
  }
  .grid{ display:grid; grid-template-columns:1fr; gap:12px }
  .row2{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
  @media (max-width:560px){ .row2{ grid-template-columns:1fr } }

  label.title{ display:block; color:var(--muted); font-size:.92rem; margin:0 0 6px }
  textarea, input[type="text"], select{
    width:100%; border:1px solid var(--border); background:transparent; color:var(--fg);
    border-radius:10px; font-size:16px; padding:11px 12px; outline:none;
  }
  textarea:focus, input[type="text"]:focus, select:focus{
    border-color:var(--accent); box-shadow:0 0 0 3px color-mix(in oklab, var(--accent) 22%, transparent);
  }
  .choices{ display:flex; flex-wrap:wrap; gap:8px }
  .chip{
    display:inline-flex; align-items:center; gap:6px; border:1px solid var(--border);
    padding:8px 10px; border-radius:999px; cursor:pointer; user-select:none; font-size:14px; background:transparent;
  }
  .chip input{ appearance:none; width:18px; height:18px; border:2px solid var(--muted); border-radius:4px; display:inline-block; position:relative }
  .chip input:checked{ border-color:var(--accent); background:var(--accent) }
  .chip input:checked::after{ content:""; position:absolute; inset:2px; background:#fff; border-radius:2px }
  .chip--radio input{ border-radius:50% }

  /* ===== ボタン行 ===== */
  .btnrow{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin:16px 0 0 }
  @media (max-width:560px){ .btnrow{ grid-template-columns:1fr } }
  .btn{
    -webkit-tap-highlight-color:transparent; user-select:none; appearance:none; border:0;
    border-radius:12px; font-size:16px; font-weight:700; padding:14px 16px; cursor:pointer;
    transition:transform .04s ease, box-shadow .2s ease, background .2s ease, opacity .2s ease;
    box-shadow:0 6px 18px rgba(0,0,0,.12)
  }
  .btn:active{ transform:translateY(1px) scale(.99) }
  .btn--primary{ color:#fff; background:linear-gradient(180deg, var(--accent), color-mix(in oklab, var(--accent) 88%, black)) }
  .btn--primary:active{ background:linear-gradient(180deg, var(--accent-press), color-mix(in oklab, var(--accent-press) 80%, black)) }
  .btn--ghost{ background:transparent; color:var(--fg); border:1px solid var(--border) }
  .btn[disabled]{ opacity:.55; cursor:not-allowed; box-shadow:none }

  /* ===== プレビュー（ページ最下部） ===== */
  .preview{ margin:28px 0 0 }
  .preview h2{ margin:0 0 10px; font-size:clamp(18px,4.8vw,22px) }
  .canvas-wrap{
    border:1px solid var(--border);
    border-radius:var(--radius);
    overflow:hidden;
    background:
      linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.06));
  }
  .canvas-inner{ aspect-ratio:3/4; }
  canvas{ width:100%; height:100%; display:block }

  .footer-actions{ margin:14px 0 0; display:grid; grid-template-columns:1fr 1fr; gap:10px }
  @media (max-width:560px){ .footer-actions{ grid-template-columns:1fr } }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>問診票画像ジェネレーター（3:4縦長）</h1>
      <p>入力・選択すると<strong>即座に下部プレビューが更新</strong>されます。PNG保存や、対応端末では共有シートでTwitterアプリ等に画像を渡せます。</p>
    </header>

    <!-- ===== 入力フォーム ===== -->
    <section>
      <div class="section-title">基本情報</div>
      <div class="grid">
        <div class="row2">
          <div>
            <label class="title" for="name">氏名</label>
            <input id="name" type="text" placeholder="例）山田 太郎">
          </div>
          <div>
            <label class="title" for="age">年齢</label>
            <input id="age" type="text" placeholder="例）34">
          </div>
        </div>

        <div>
          <label class="title">性別（単一選択）</label>
          <div class="choices" data-name="sex" id="sex-choices">
            <label class="chip chip--radio"><input type="radio" name="sex" value="男性" checked>男性</label>
            <label class="chip chip--radio"><input type="radio" name="sex" value="女性">女性</label>
            <label class="chip chip--radio"><input type="radio" name="sex" value="その他">その他</label>
            <label class="chip chip--radio"><input type="radio" name="sex" value="無回答">無回答</label>
          </div>
        </div>
      </div>

      <div class="section-title">主訴</div>
      <div class="choices" id="chief-choices">
        <label class="chip"><input type="checkbox" value="発熱" checked>発熱</label>
        <label class="chip"><input type="checkbox" value="咳">咳</label>
        <label class="chip"><input type="checkbox" value="喉の痛み" checked>喉の痛み</label>
        <label class="chip"><input type="checkbox" value="鼻水">鼻水</label>
        <label class="chip"><input type="checkbox" value="頭痛">頭痛</label>
        <label class="chip"><input type="checkbox" value="吐き気">吐き気</label>
        <label class="chip"><input type="checkbox" value="腹痛">腹痛</label>
        <label class="chip"><input type="checkbox" value="倦怠感">倦怠感</label>
        <label class="chip"><input type="checkbox" value="関節痛">関節痛</label>
      </div>

      <div class="section-title">発症時期・体温</div>
      <div class="grid">
        <div class="row2">
          <div>
            <div class="choices" id="onset-choices">
              <label class="chip chip--radio"><input type="radio" name="onset" value="本日" checked>本日</label>
              <label class="chip chip--radio"><input type="radio" name="onset" value="昨日">昨日</label>
              <label class="chip chip--radio"><input type="radio" name="onset" value="2〜3日前">2〜3日前</label>
              <label class="chip chip--radio"><input type="radio" name="onset" value="1週間以上前">1週間以上前</label>
            </div>
          </div>
          <div>
            <label class="title" for="temp">体温（任意）</label>
            <input id="temp" type="text" placeholder="例）38.2 ℃">
          </div>
        </div>
      </div>

      <div class="section-title">既往歴</div>
      <div class="choices" id="pmh-choices">
        <label class="chip"><input type="checkbox" value="高血圧">高血圧</label>
        <label class="chip"><input type="checkbox" value="糖尿病">糖尿病</label>
        <label class="chip"><input type="checkbox" value="心疾患">心疾患</label>
        <label class="chip"><input type="checkbox" value="喘息">喘息</label>
        <label class="chip"><input type="checkbox" value="花粉症">花粉症</label>
        <label class="chip"><input type="checkbox" value="特記なし" checked>特記なし</label>
      </div>

      <div class="section-title">服薬・アレルギー</div>
      <div class="grid row2">
        <div>
          <label class="title" for="meds">服用中の薬（任意）</label>
          <input id="meds" type="text" placeholder="例）総合感冒薬、解熱鎮痛薬 など">
        </div>
        <div>
          <label class="title" for="allergy">アレルギー（任意）</label>
          <input id="allergy" type="text" placeholder="例）ペニシリン、そば など">
        </div>
      </div>

      <div class="section-title">症状の詳細（自由記入）</div>
      <div class="grid">
        <textarea id="detail" rows="4" placeholder="例）今朝から寒気と38度台の発熱。咳は少し。水分は摂れている。家族で同様の症状あり。"></textarea>
      </div>

      <div class="btnrow">
        <button id="btn-save" class="btn btn--ghost" type="button">PNG保存</button>
        <button id="btn-share" class="btn btn--primary" type="button">Twitter等に共有（Web Share）</button>
      </div>
    </section>

    <!-- ===== プレビュー（ページ一番下） ===== -->
    <section class="preview">
      <h2>プレビュー（自動更新 / 3:4）</h2>
      <div class="canvas-wrap">
        <div class="canvas-inner">
          <canvas id="cv" width="900" height="1200" aria-label="問診票画像プレビュー"></canvas>
        </div>
      </div>
      <p style="color:var(--muted); margin:10px 0 0; font-size:.9rem">※ 画像は入力と同時に再生成されます。</p>
    </section>
  </div>

<script>
  // ========= Canvas 基本：Retina対応（3:4縦長） =========
  const cv = document.getElementById('cv');
  const ctx = cv.getContext('2d');

  function fitCanvasToDisplaySize(canvas) {
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    const { width: cssW, height: cssH } = canvas.getBoundingClientRect();
    const displayW = Math.round(cssW * dpr);
    const displayH = Math.round(cssH * dpr);
    if (canvas.width !== displayW || canvas.height !== displayH) {
      canvas.width = displayW;
      canvas.height = displayH;
      return true;
    }
    return false;
  }

  // ========= ユーティリティ（描画） =========
  function roundRectPath(ctx, x, y, w, h, r) {
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr, y);
    ctx.arcTo(x+w, y, x+w, y+h, rr);
    ctx.arcTo(x+w, y+h, x, y+h, rr);
    ctx.arcTo(x, y+h, x, y, rr);
    ctx.arcTo(x, y, x+w, y, rr);
    ctx.closePath();
  }

  function drawHeader(w, h, name, age, sex) {
    // タイトル行（カコミなし）
    const pad = Math.floor(Math.min(w,h)*0.04);
    const headH = Math.floor(h*0.11);
    const x = pad, y = pad, ww = w - pad*2, hh = headH;

    ctx.fillStyle = '#2f81f7';
    ctx.fillRect(x, y, Math.round(ww*0.012), hh);

    ctx.fillStyle = '#0f1720';
    ctx.font = `800 ${Math.round(hh*0.42)}px system-ui, "Noto Sans JP"`;
    ctx.fillText('問診票', x + Math.round(ww*0.02), y + Math.round(hh*0.68));

    // 日付（右上）
    const ts = new Date().toLocaleString('ja-JP', { year:'numeric', month:'2-digit', day:'2-digit' });
    ctx.font = `600 ${Math.round(hh*0.26)}px system-ui, "Noto Sans JP"`;
    const dsW = ctx.measureText(ts).width;
    ctx.fillText(ts, x + ww - dsW, y + Math.round(hh*0.68));

    // 基本情報（下線だけ）
    const baseY = y + hh + Math.round(pad*0.5);
    const rowH = Math.round(h*0.060);
    ctx.fillStyle = '#0f1720';
    ctx.font = `600 ${Math.round(rowH*0.42)}px system-ui, "Noto Sans JP"`;
    ctx.fillText('氏名', x, baseY + Math.round(rowH*0.85));
    ctx.fillText('年齢 / 性別', x + Math.round(ww*0.52), baseY + Math.round(rowH*0.85));

    ctx.font = `500 ${Math.round(rowH*0.42)}px system-ui, "Noto Sans JP"`;
    ctx.fillText(name || '（未入力）', x + Math.round(rowH*2.2), baseY + Math.round(rowH*0.85));
    ctx.fillText(((age||'—') + ' ／ ' + (sex||'—')), x + Math.round(ww*0.52) + Math.round(rowH*4.0), baseY + Math.round(rowH*0.85));

    // 罫線
    ctx.strokeStyle = 'rgba(0,0,0,0.18)';
    ctx.lineWidth = Math.max(1, Math.round(h*0.0015));
    ctx.beginPath();
    ctx.moveTo(x, baseY + rowH + Math.round(h*0.01));
    ctx.lineTo(x + ww, baseY + rowH + Math.round(h*0.01));
    ctx.stroke();

    return baseY + rowH + Math.round(h*0.04);
  }

  function drawSectionTitle(x, y, text) {
    ctx.fillStyle = '#2f81f7';
    ctx.fillRect(x, y, 6, 20);
    ctx.fillStyle = '#0f1720';
    ctx.font = `800 28px system-ui, "Noto Sans JP"`;
    ctx.fillText(text, x + 12, y + 18);
    return y + 28;
  }

  function drawChecks(x, startY, w, labels, checkedSet) {
    const lineH = Math.max(28, Math.round(w*0.035));
    const box = Math.round(lineH*0.8);
    const gap = Math.round(lineH*0.45);
    let y = startY;
    ctx.lineWidth = Math.max(1, Math.round(lineH*0.06));

    labels.forEach((label) => {
      // ボックス
      ctx.strokeStyle = 'rgba(0,0,0,0.35)';
      ctx.strokeRect(x, y - box + Math.round(box*0.1), box, box);
      if (checkedSet.has(label)) {
        ctx.fillStyle = '#2f81f7';
        ctx.fillRect(x, y - box + Math.round(box*0.1), box, box);
        ctx.fillStyle = '#fff';
        ctx.font = `700 ${Math.round(box*0.8)}px system-ui`;
        ctx.fillText('✓', x + Math.round(box*0.06), y + Math.round(box*0.2));
      }
      // ラベル
      ctx.fillStyle = '#0f1720';
      ctx.font = `500 ${Math.round(lineH*0.58)}px system-ui, "Noto Sans JP"`;
      ctx.fillText(label, x + box + Math.round(box*0.6), y);
      y += lineH + gap*0.4;
    });
    return y;
  }

  function drawRadios(x, startY, w, options, value) {
    const lineH = Math.max(28, Math.round(w*0.035));
    const r = Math.round(lineH*0.45);
    const gap = Math.round(lineH*0.45);
    let y = startY;
    ctx.lineWidth = Math.max(1, Math.round(lineH*0.06));

    options.forEach((label)=>{
      ctx.strokeStyle = 'rgba(0,0,0,0.35)';
      ctx.beginPath(); ctx.arc(x + r, y - r + Math.round(r*0.1), r, 0, Math.PI*2); ctx.stroke();
      if (value === label) {
        ctx.fillStyle = '#2f81f7';
        ctx.beginPath(); ctx.arc(x + r, y - r + Math.round(r*0.1), Math.round(r*0.6), 0, Math.PI*2); ctx.fill();
      }
      ctx.fillStyle = '#0f1720';
      ctx.font = `500 ${Math.round(lineH*0.58)}px system-ui, "Noto Sans JP"`;
      ctx.fillText(label, x + r*2 + Math.round(r*0.6), y);
      y += lineH + gap*0.4;
    });
    return y;
  }

  function drawMultiLineText(x, y, w, text, linePx, maxLines=8) {
    const words = (text||'').split('');
    let line = '', lines=[];
    words.forEach(ch=>{
      const m = ctx.measureText(line + ch);
      if (m.width > w && line) { lines.push(line); line = ch; }
      else { line += ch; }
    });
    if (line) lines.push(line);
    lines.slice(0, maxLines).forEach((ln, i)=>{
      ctx.fillText(ln, x, y + i*linePx);
    });
    return y + Math.min(lines.length, maxLines)*linePx;
  }

  // ========= 値の取得 =========
  const $ = (sel)=>document.querySelector(sel);
  function getRadio(name){ const el = document.querySelector(`input[name="${name}"]:checked`); return el ? el.value : '' }
  function getChecks(containerId){
    const set = new Set(); const box = document.getElementById(containerId);
    box.querySelectorAll('input[type="checkbox"]').forEach(ch => { if (ch.checked) set.add(ch.value) });
    return set;
  }

  // ========= メイン描画（フォームの現在値から即時再生成） =========
  function drawFromForm(){
    fitCanvasToDisplaySize(cv);
    const w = cv.width, h = cv.height;
    ctx.clearRect(0,0,w,h);

    // 用紙背景（白）
    ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,w,h);

    const name = $('#name').value.trim();
    const age  = $('#age').value.trim();
    const sex  = getRadio('sex') || '—';
    const onset = getRadio('onset') || '—';
    const temp = $('#temp').value.trim();
    const meds = $('#meds').value.trim();
    const allergy = $('#allergy').value.trim();
    const chief = getChecks('chief-choices');
    const pmh = getChecks('pmh-choices');
    const detail = $('#detail').value.trim();

    let y = drawHeader(w, h, name, age, sex);

    const padX = Math.round(Math.min(w,h)*0.06);
    const colW = w - padX*2;
    const gapY = Math.round(h*0.02);
    ctx.fillStyle = '#0f1720';

    // 主訴
    y = drawSectionTitle(padX, y, '主訴');
    y = drawChecks(padX + 8, y + 14, w,
      Array.from(document.querySelectorAll('#chief-choices input')).map(i=>i.value),
      chief
    );
    y += gapY;

    // 発症時期・体温
    y = drawSectionTitle(padX, y, '発症時期・体温');
    let yy = drawRadios(padX + 8, y + 14, w, ['本日','昨日','2〜3日前','1週間以上前'], onset);
    // 体温右側表示
    ctx.font = `700 ${Math.round(colW*0.035)}px system-ui, "Noto Sans JP"`;
    ctx.fillText('体温', padX + Math.round(colW*0.55), y + Math.round(colW*0.08));
    ctx.font = `500 ${Math.round(colW*0.035)}px system-ui, "Noto Sans JP"`;
    ctx.fillText(temp || '—', padX + Math.round(colW*0.55) + Math.round(colW*0.12), y + Math.round(colW*0.08));
    y = Math.max(yy, y + Math.round(colW*0.16));
    y += gapY;

    // 既往歴
    y = drawSectionTitle(padX, y, '既往歴');
    y = drawChecks(padX + 8, y + 14, w,
      Array.from(document.querySelectorAll('#pmh-choices input')).map(i=>i.value),
      pmh
    );
    y += gapY;

    // 服薬・アレルギー
    y = drawSectionTitle(padX, y, '服用中の薬・アレルギー');
    ctx.font = `700 ${Math.round(colW*0.035)}px system-ui, "Noto Sans JP"`;
    ctx.fillText('服用中の薬', padX + 8, y + Math.round(colW*0.07));
    ctx.font = `500 ${Math.round(colW*0.035)}px system-ui, "Noto Sans JP"`;
    ctx.fillText(meds || '—', padX + Math.round(colW*0.22), y + Math.round(colW*0.07));
    ctx.font = `700 ${Math.round(colW*0.035)}px system-ui, "Noto Sans JP"`;
    ctx.fillText('アレルギー', padX + 8, y + Math.round(colW*0.14));
    ctx.font = `500 ${Math.round(colW*0.035)}px system-ui, "Noto Sans JP"`;
    ctx.fillText(allergy || '—', padX + Math.round(colW*0.22), y + Math.round(colW*0.14));
    y += Math.round(colW*0.2);
    y += gapY;

    // 自由記入
    y = drawSectionTitle(padX, y, '症状の詳細（自由記入）');
    const boxH = Math.round(h*0.18);
    roundRectPath(ctx, padX + 6, y + 10, colW - 12, boxH, 10);
    ctx.fillStyle = 'rgba(0,0,0,0.04)'; ctx.fill();
    ctx.strokeStyle = 'rgba(0,0,0,0.15)'; ctx.stroke();
    ctx.fillStyle = '#0f1720';
    ctx.font = `500 ${Math.round(colW*0.035)}px system-ui, "Noto Sans JP"`;
    drawMultiLineText(padX + 18, y + 18 + Math.round(colW*0.035), colW - 36, detail || '—', Math.round(colW*0.05), 7);
    y += boxH + gapY;

    // 署名
    const footH = Math.round(h*0.09);
    ctx.fillStyle = '#0f1720';
    ctx.font = `700 ${Math.round(footH*0.28)}px system-ui, "Noto Sans JP"`;
    const baseY = h - footH - Math.round(colW*0.02) + Math.round(footH*0.55);
    ctx.fillText('署名：', padX + 10, baseY);
    ctx.font = `500 ${Math.round(footH*0.28)}px system-ui, "Noto Sans JP"`;
    ctx.fillText(name || '（署名）', padX + 10 + Math.round(footH*1.4), baseY);
  }

  // ========= 即時再生成（input/change） =========
  const formRoot = document.body;
  const redraw = () => { window.requestAnimationFrame(drawFromForm); };

  // 全入力要素にイベント委譲（ラジオ/チェック/テキスト/テキストエリア/セレクト）
  formRoot.addEventListener('input', (e) => {
    if (e.target.closest('input, textarea, select')) redraw();
  });
  formRoot.addEventListener('change', (e) => {
    if (e.target.closest('input, textarea, select')) redraw();
  });

  // 初期描画＆リサイズ追従
  const ro = new ResizeObserver(()=>drawFromForm());
  ro.observe(cv);
  window.addEventListener('orientationchange', ()=>setTimeout(drawFromForm, 120));
  drawFromForm();

  // ========= 保存・共有 =========
  const btnSave = document.getElementById('btn-save');
  const btnShare = document.getElementById('btn-share');

  btnSave.addEventListener('click', async ()=>{
    const blob = await new Promise(r => cv.toBlob(r, 'image/png'));
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `問診票_${Date.now()}.png`;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  });

  function canUseShareWithFiles(){
    if (!('share' in navigator)) return false;
    try {
      const test = new File(["x"], "x.txt", { type:"text/plain" });
      return typeof navigator.canShare !== 'function' || navigator.canShare({ files:[test] });
    } catch { return false; }
  }
  if (!canUseShareWithFiles()){
    btnShare.disabled = true;
    btnShare.textContent = '共有非対応のブラウザです（PNG保存→手動投稿）';
  }

  btnShare.addEventListener('click', async ()=>{
    try{
      const blob = await new Promise(r => cv.toBlob(r, 'image/png'));
      const file = new File([blob], 'monshin.png', { type:'image/png' });
      await navigator.share({ text:'問診票画像', files:[file] });
    }catch(e){
      if (e && e.name === 'AbortError') return;
      alert('共有に失敗しました: ' + (e?.message || e));
    }
  }, { passive:true });
</script>
</body>
</html>
